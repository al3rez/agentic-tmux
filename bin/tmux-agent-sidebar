#!/bin/bash
# Minimal agent sidebar

my_pid=$$
tput civis
trap "tput cnorm; exit" INT TERM EXIT

get_agent() {
    local pid="$1"
    local path="$2"

    if [[ -n "$pid" ]]; then
        # Get the process tree (pane pid + children)
        local pids=$(pgrep -P "$pid" 2>/dev/null)
        for p in $pid $pids; do
            cmdline=$(ps -p "$p" -o args= 2>/dev/null | tr '[:upper:]' '[:lower:]')
            
            # Direct commands
            [[ "$cmdline" == *"gemini"* ]] && echo "â™Š gemini" && return
            [[ "$cmdline" == *"claude"* ]] && echo "ğŸ¦€ claude" && return
            [[ "$cmdline" == *"codex"* ]] && echo "ğŸ¤– codex" && return
            [[ "$cmdline" == *"ssh"* ]] && echo "ğŸŒ remote" && return
            [[ "$cmdline" == *"nvim"* ]] && echo "ğŸ“ nvim" && return
            [[ "$cmdline" == *"vim"* ]] && echo "ğŸ“ vim" && return
        done
    fi

    local path_lower=$(echo "$path" | tr '[:upper:]' '[:lower:]')
    # Path detection as fallback
    [[ "$path_lower" == *"/claude"* ]] && echo "ğŸ¦€ claude" && return
    [[ "$path_lower" == *"/codex"* ]] && echo "ğŸ¤– codex" && return
    [[ "$path_lower" == *"/gemini"* ]] && echo "â™Š gemini" && return

    echo "   â”€      "
}

clear
while true; do
    current=$(tmux display-message -p '#{pane_index}')
    lines=()

    while IFS='|' read -r idx pid path; do
        [[ "$pid" == "$my_pid" ]] && continue

        agent=$(get_agent "$pid" "$path")
        mark=" "
        [[ "$idx" == "$current" ]] && mark="â–¶"
        lines+=("$mark $agent")

        [[ ${#lines[@]} -ge 4 ]] && break
    done <<< "$(tmux list-panes -F '#{pane_index}|#{pane_pid}|#{pane_current_path}')"

    tput cup 0 0
    for line in "${lines[@]}"; do
        printf "%-14s\n" "$line"
    done
    # Clear remaining lines
    for ((i=${#lines[@]}; i<4; i++)); do
        printf "%-14s\n" ""
    done

    sleep 1
done
